{% extends "base.html" %}

{% block title %}Extensions - Extension Security Auditor{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Inventaire des Extensions</h1>
        <button class="btn btn-primary" onclick="refreshData()">
            <i class="bi bi-arrow-clockwise"></i> Actualiser
        </button>
    </div>
    
    <div class="stat-card mb-4">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Navigateur</label>
                <select class="form-select" id="filter-browser" onchange="applyFilters()">
                    <option value="">Tous</option>
                    <option value="chrome">Chrome</option>
                    <option value="firefox">Firefox</option>
                    <option value="edge">Edge</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label class="form-label">Niveau de Risque</label>
                <select class="form-select" id="filter-risk" onchange="applyFilters()">
                    <option value="">Tous</option>
                    <option value="critical">Critique (70+)</option>
                    <option value="high">Élevé (50-69)</option>
                    <option value="medium">Moyen (30-49)</option>
                    <option value="low">Faible (0-29)</option>
                </select>
            </div>
            
            <div class="col-md-6">
                <label class="form-label">Recherche</label>
                <input type="text" class="form-control" id="search-input" 
                       placeholder="Nom de l'extension..." onkeyup="applyFilters()">
            </div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Extension</th>
                        <th>Navigateur</th>
                        <th>Version</th>
                        <th>Permissions</th>
                        <th>Score de Risque</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="extensions-table">
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="mt-3 text-muted" id="results-count"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allExtensions = [];
    let filteredExtensions = [];
    
    async function loadExtensions() {
        try {
            const response = await fetch('/api/dashboard/extensions');
            allExtensions = await response.json();
            filteredExtensions = allExtensions;
            renderTable();
        } catch (error) {
            console.error('Erreur chargement extensions:', error);
            document.getElementById('extensions-table').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">Erreur de chargement</td></tr>';
        }
    }
    
    function applyFilters() {
        const browserFilter = document.getElementById('filter-browser').value;
        const riskFilter = document.getElementById('filter-risk').value;
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        
        filteredExtensions = allExtensions.filter(ext => {
            if (browserFilter && ext.browser !== browserFilter) return false;
            
            if (riskFilter) {
                const score = ext.risk_score || 0;
                switch(riskFilter) {
                    case 'critical': if (score < 70) return false; break;
                    case 'high': if (score < 50 || score >= 70) return false; break;
                    case 'medium': if (score < 30 || score >= 50) return false; break;
                    case 'low': if (score >= 30) return false; break;
                }
            }
            
            if (searchTerm && !ext.name.toLowerCase().includes(searchTerm)) {
                return false;
            }
            
            return true;
        });
        
        renderTable();
    }
    
    function renderTable() {
        const tbody = document.getElementById('extensions-table');
        
        if (filteredExtensions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">Aucune extension trouvée</td></tr>';
            document.getElementById('results-count').textContent = '';
            return;
        }
        
        let html = '';
        filteredExtensions.forEach(ext => {
            const riskBadge = getRiskBadge(ext.risk_score || 0);
            const browserIcon = getBrowserIcon(ext.browser);
            
            html += `
                <tr onclick="window.location.href='/extension/${ext.id}'">
                    <td>
                        <strong>${escapeHtml(ext.name)}</strong><br>
                        <small class="text-muted">${escapeHtml(ext.extension_id.substring(0, 16))}...</small>
                    </td>
                    <td>${browserIcon} ${ext.browser}</td>
                    <td><span class="badge bg-secondary">${escapeHtml(ext.version)}</span></td>
                    <td>${ext.permissions ? ext.permissions.length : 0}</td>
                    <td>${riskBadge}</td>
                    <td>
                        <a href="/extension/${ext.id}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye"></i> Détails
                        </a>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
        
        document.getElementById('results-count').textContent = 
            `${filteredExtensions.length} extension(s) affichée(s) sur ${allExtensions.length}`;
    }
    
    function getRiskBadge(score) {
        if (score >= 70) {
            return `<span class="badge badge-risk-critical">${score}</span>`;
        } else if (score >= 50) {
            return `<span class="badge badge-risk-high">${score}</span>`;
        } else if (score >= 30) {
            return `<span class="badge badge-risk-medium">${score}</span>`;
        } else {
            return `<span class="badge badge-risk-low">${score}</span>`;
        }
    }
    
    function getBrowserIcon(browser) {
        const icons = {
            'chrome': '<i class="bi bi-google text-primary"></i>',
            'firefox': '<i class="bi bi-browser-firefox text-warning"></i>',
            'edge': '<i class="bi bi-browser-edge text-info"></i>'
        };
        return icons[browser] || '<i class="bi bi-puzzle"></i>';
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function refreshData() {
        loadExtensions();
    }
    
    loadExtensions();
</script>
{% endblock %}